+++
# --- Basic Metadata ---
id = "WF-CONTEXT7-REFRESH-001"
title = "Workflow: Context7 KB Refresh (v1.2)" # Updated title
status = "draft"
created_date = "2025-04-27"
updated_date = "2025-04-27" # Use current date
version = "1.2" # Updated version
tags = [
    "workflow", "kb-enrichment", "context7", "script-integration", "modes", "pipeline",
    "documentation", "sop", "context-handling", "json-context", "subfolders",
    "existing-mode", "url", "summary-rule", "refresh", "source-info", "mcp", "crawl", "fallback" # Added tags
]

# --- Ownership & Context ---
owner = "Roo Commander"
related_docs = [
    ".ruru/workflows/WF-CONTEXT7-ENRICHMENT-001.md", # Source workflow
    "process_llms_json.js", # The script used
    ".roo/rules/01-standard-toml-md-format.md",
    ".roo/rules/04-mdtm-workflow-initiation.md",
    ".roo/rules/08-logging-procedure-simplified.md",
    ".roo/rules/10-vertex-mcp-usage-guideline.md", # Added MCP rule
    ".ruru/processes/acqa-process.md",
    ".ruru/processes/afr-process.md",
    ".ruru/processes/pal-process.md"
]
related_templates = []

# --- Workflow Specific Fields ---
objective = "Define the step-by-step procedure for *refreshing* an existing specialist mode's Context7 KB. This involves cleaning the existing directory, retrieving the source URL, optionally attempting to fetch source details (like token count, update date) via MCP/Crawling or user input, falling back to assumptions if needed, re-running the `process_llms_json.js` script, and updating related artifacts." # Updated objective
scope = "Covers the end-to-end process for *refreshing* an existing mode's Context7 KB. Includes gathering target mode, retrieving and confirming the source URL, optionally fetching/validating source details (with fallback), cleaning the existing `kb/context7` directory, executing the processing script, generating/updating the Context7 summary rule, verifying the generated KB index (`kb/context7/_index.json`), updating the KB README, ensuring KB usage strategy exists, updating mode definition context, QA, user review, and cleanup." # Updated scope
roles = [
    "User", "Coordinator (Roo Commander)",
    "Mode Structure Agent (e.g., mode-maintainer, technical-writer)",
    "Specialist Agent (e.g., agent-context-condenser, technical-writer, potentially crawler/fetcher agents)", # Updated specialist roles
    "QA Agent (e.g., code-reviewer)"
]
trigger = "Manual initiation by Roo Commander or User for a specific Context7 base URL and target *existing* mode requiring a KB refresh."
success_criteria = [
    "Target mode's KB contains refreshed context files in the `kb/context7/` subdirectory.",
    "Target mode's KB includes a valid `kb/context7/_index.json` file generated by the script.",
    "A summary rule file exists at `.roo/rules-[mode_slug]/05-context7-summary.md` (or similar prefix) listing the KB topics.",
    "Target mode's KB README (`kb/README.md`) is updated referencing the `context7` directory, its `_index.json`, the confirmed source URL, and the status of source detail fetching (obtained/assumed).", # Updated criteria
    "Target mode has an internal KB usage strategy document (`kb/00-kb-usage-strategy.md`).",
    "Target mode's configuration (`.mode.md`) references `kb/context7/_index.json` in `related_context`.",
    "The refreshed structure passes Quality Assurance (QA) review.",
    "User confirms the refresh meets initial requirements."
]
failure_criteria = [
    "Failure to get valid target mode or confirm Context7 base URL/detail status.", # Updated criteria
    "Failure cleaning the existing `kb/context7` directory (permission errors).",
    "Failure executing the `process_llms_json.js` script.",
    "Failure generating the Context7 summary rule.",
    "Failure during KB README or mode definition updates.",
    "Failure to ensure usage strategy document exists.",
    "Generated `_index.json` or content fails validation/QA checks.",
    "User rejects the final refresh."
]

# --- Integration ---
acqa_applicable = true # Requires ACQA review
pal_validated = false
validation_notes = ""

# --- AI Interaction Hints (Optional) ---
context_type = "workflow_definition"
+++

# Workflow: Context7 KB Refresh (v1.2) # Updated title

## 1. Objective üéØ

To define the step-by-step procedure for **refreshing** an existing specialist mode's KB using AI-processed context derived **specifically** from a Context7 base URL. This involves cleaning the existing directory, retrieving and confirming the source URL, optionally attempting to fetch source details (like token count, update date) via MCP/Crawling or user input, falling back to assumptions if needed, re-running the `process_llms_json.js` script, and updating related artifacts including the summary rule file. # Updated objective

## 2. Scope ‚ÜîÔ∏è

This workflow covers the end-to-end process for **refreshing** an existing mode's Context7 KB. It includes gathering the target mode slug, retrieving and confirming the source URL, optionally attempting to fetch/validate source details (like token count, update date) using MCP/Crawling or user input (with fallback to assumptions), cleaning the existing `kb/context7` directory, executing the `process_llms_json.js` script, generating/updating the Context7 summary rule, verifying the generated KB index (`kb/context7/_index.json`), updating the KB README, ensuring the KB usage strategy document exists, updating the mode definition file, performing QA, facilitating user review, and cleanup. # Updated scope

## 3. Roles & Responsibilities üë§

*   **User:** Initiates or confirms the request, provides target mode slug, confirms the retrieved Context7 base URL and detail fetching approach, potentially provides source details manually, and confirms final refresh. # Updated role
*   **Coordinator (Roo Commander):** Orchestrates the workflow, interacts with the User, delegates tasks (including potential fetching/crawling), performs QA, and manages finalization steps. # Updated role
*   **Mode Structure Agent:** (Worker Agent, e.g., `mode-maintainer`, `technical-writer`) Updates README, usage strategy, and mode definition file, preferring MCP tools.
*   **Specialist Agent:** (Worker Agent, e.g., `agent-context-condenser`, `technical-writer`, potentially `spec-crawl4ai`, `spec-firecrawl`, or MCP tool users) Fetches/Crawls source details if requested, scans KB directory, and generates/updates the Context7 summary rule file. # Updated role
*   **QA Agent:** (Worker Agent, potentially Coordinator) Reviews generated artifacts against standards and requirements (part of ACQA process).

## 4. Preconditionsüö¶

*   The target specialist mode (`[mode_slug]`) exists.
*   The target mode's Context7 source info file (`.ruru/modes/[mode_slug]/kb/context7/source_info.json`) exists and contains the `"baseUrl"` key (or the user can provide it).
*   The `process_llms_json.js` script exists in the workspace root and is functional (using `process.argv` for args).
*   Network access is available for the script and potentially for fetching/crawling tools. # Updated precondition
*   Required agents (`mode-maintainer`, `agent-context-condenser`, potentially crawling specialists) are operational. # Updated precondition
*   Relevant MCP servers (for file operations, potentially crawling/fetching like `vertex-ai-mcp-server`) are connected (preferred). # Updated precondition
*   The User is available for interaction.

## 5. Reference Documents & Tools üìöüõ†Ô∏è

*   Processing Script: `process_llms_json.js`
*   Source Enrichment Workflow: `.ruru/workflows/WF-CONTEXT7-ENRICHMENT-001.md`
*   Relevant Rules: `.roo/rules/`, `.roo/rules-[mode_slug]/` (TOML format, Logging, MCP Usage, OS Aware Commands, etc.)
*   Relevant Processes: ACQA, AFR, PAL
*   **MCP Tools (Preferred):** `read_file_content`, `write_file_content`, `create_directory`, `list_directory_contents`, `edit_file_content`, `get_filesystem_info`, `search_filesystem`, potentially crawling/fetching tools (e.g., from `vertex-ai-mcp-server`, `upsplash-mcp-server` if applicable, or custom crawlers). # Updated tools
*   **Fallback Tools:** `read_file`, `write_to_file`, `execute_command` (`mkdir`, `rm`), `list_files`, `apply_diff`, `insert_content`, `search_files`, `ask_followup_question`
*   **Specialist Modes (Potential):** `spec-crawl4ai`, `spec-firecrawl`

## 6. Workflow Steps ü™ú

*(Coordinator: `roo-commander` unless otherwise specified)*

*   **Step 1: Initiation, URL Retrieval & Detail Handling (Coordinator, User)**
    *   **1.1:** Coordinator asks User for an approximate name or part of the slug for the target mode. Store as `[approx_mode_name]`.
    *   **1.2:** Coordinator uses `list_files` on `.ruru/modes/` (non-recursive) to get a list of all mode slugs.
    *   **1.3:** Coordinator filters the list based on `[approx_mode_name]`.
    *   **1.4:** If exactly one match, propose for confirmation. If multiple, present options via `ask_followup_question`. If none, ask for different name. Store confirmed slug as `[mode_slug]`. Handle errors/cancellation.
    *   **1.5:** Define `[source_info_path] = .ruru/modes/[mode_slug]/kb/context7/source_info.json`.
    *   **1.6:** Use `read_file` (or MCP `read_file_content`) to read the content of `[source_info_path]`. Handle file not found error (Log, **Stop**).
    *   **1.7:** Parse the JSON content of `[source_info_path]`. Extract the value associated with the `"baseUrl"` key and store it as `[context7_base_url]`. If the file doesn't exist, is not valid JSON, or lacks the `"baseUrl"` key, log the error, ask User to provide the URL manually via `ask_followup_question`, and store as `[context7_base_url]`. Handle errors/cancellation.
    *   **1.8 (New): Attempt Detail Fetching (Optional):**
        *   Ask User via `ask_followup_question`: "Do you want to attempt fetching/validating details (like token count, update date) from the source at `[context7_base_url]` using MCP/Crawling tools before processing? This might provide more accurate context but could take longer or fail." Suggested answers: "Yes, attempt fetching", "No, proceed with assumptions".
        *   If User agrees ("Yes, attempt fetching"):
            *   Delegate to a suitable Specialist Agent (e.g., using MCP tools like `vertex-ai-mcp-server`'s `read_file_content`, or modes like `spec-crawl4ai`/`spec-firecrawl`) to fetch content from `[context7_base_url]`.
            *   If fetch successful: Attempt to parse the content (assuming `llms.json`) and extract details like `total_tokens` (or similar) and `last_updated`. Store as `[fetched_token_count]`, `[fetched_update_date]`. Log success. Set `[detail_status] = "obtained"`.
            *   If fetch fails: Log failure. Ask User via `ask_followup_question`: "Fetching details failed. Provide details manually (e.g., estimated token count)? Or proceed with default assumptions?" Suggested answers: "Provide manually", "Use defaults".
                *   If User chooses "Provide manually": Ask for details (e.g., token count). Store as `[manual_token_count]`. Log manual input. Set `[detail_status] = "obtained"`.
                *   If User chooses "Use defaults": Set `[assumed_token_count] = 10000000`. Log fallback to default. Set `[detail_status] = "assumed"`.
        *   If User initially declines fetching ("No, proceed with assumptions"): Set `[assumed_token_count] = 10000000`. Log skipping fetch, fallback to default. Set `[detail_status] = "assumed"`.
    *   **1.9 (Was 1.8): Confirm URL & Detail Status:** Ask User via `ask_followup_question` to confirm the `[context7_base_url]` and acknowledge the detail status (`[detail_status]`: obtained/assumed) before proceeding. Handle rejection (**Stop**).
    *   **1.10 (Was 1.9):** Log confirmed `[mode_slug]`, `[context7_base_url]`, and `[detail_status]` (plus any obtained/assumed details like token count).

*   **Step 1.B: Clean Existing Context7 Directory (Coordinator)**
    *   **1.B.1:** Define `[context7_output_dir] = .ruru/modes/[mode_slug]/kb/context7`.
    *   **1.B.2:** Use `execute_command` to run `rm -rf "[context7_output_dir]"`. Ensure OS-aware command generation (Rule `05`).
    *   **1.B.3:** Explain the command (removes the existing directory to ensure a clean refresh).
    *   **1.B.4:** Log the execution attempt. Note: This command might fail harmlessly if the directory doesn't exist; proceed unless there's a permission error. Handle permission errors (Log, **Stop**).

*   **Step 2: Execute Processing Script (Coordinator)**
    *   **2.1:** Use `execute_command` to run the script: `node process_llms_json.js --baseUrl "[context7_base_url]" --outputDir "[context7_output_dir]"`. Ensure OS-aware command generation (Rule `05`).
    *   **2.2:** Explain the command to the user. Note: The script will process the `llms.json` found at the `baseUrl`. If details like token count were not explicitly fetched/provided (`[detail_status] == "assumed"`), the script's behavior might rely on internal defaults or assumptions based on the fetched JSON structure. (Script modification might be needed separately if it requires explicit token counts).
    *   **2.3:** Check the command's exit code. If non-zero, log the error and output, inform the user, and **Stop** the workflow.
    *   **2.4:** Log successful execution of the script and generation of `kb/context7/_index.json`.

*   **Step 3: Generate/Update Context7 Summary Rule (Coordinator delegates to Specialist Agent)**
    *   **3.1:** Coordinator determines the appropriate specialist (e.g., `agent-context-condenser`, `technical-writer`) for generating the summary rule.
    *   **3.2:** Coordinator delegates the task via MDTM or `new_task` with the following instructions:
        *   Define `[context7_kb_dir] = .ruru/modes/[mode_slug]/kb/context7`.
        *   Define `[rules_dir] = .roo/rules-[mode_slug]/`.
        *   Define `[summary_rule_path] = [rules_dir]05-context7-summary.md`. (Note: Check if `05` prefix is available, adjust if necessary, e.g., `06`, `07`...).
        *   Recursively scan `[context7_kb_dir]` to find all files named `_index.json` (Prefer MCP `search_filesystem`, fallback `search_files` or `list_files` recursive + filter).
        *   Prepare the content for `[summary_rule_path]`:
            *   **TOML Frontmatter:**
                ```toml
                +++
                id = "RULE-[MODE_SLUG]-CONTEXT7-SUMMARY-V1" # Generate unique ID
                title = "Context7 KB Scope Summary ([mode_slug])"
                context_type = "rules"
                scope = "summary"
                status = "active"
                last_updated = "2025-04-27" # Use current date
                tags = ["rules", "summary", "context7", "kb", "[mode_slug]"]
                related_context = [".ruru/modes/[mode_slug]/kb/context7/_index.json"]
                template_schema_doc = ".ruru/templates/toml-md/16_ai_rule.README.md"
                relevance = "Provides a quick overview of the topics covered in the Context7 KB."
                +++
                ```
            *   **Markdown Body:**
                ```markdown
                # Context7 Knowledge Base Summary for `[mode_slug]`

                This rule provides a summary of the main topics found within the Context7-derived Knowledge Base located at `.ruru/modes/[mode_slug]/kb/context7/`.

                ## Main Topics

                *   [List each found `_index.json` file, deriving the topic name from its directory path relative to `kb/context7/`, and linking to the file path relative to the workspace root.]
                    *   Example: `- Core Concepts: .ruru/modes/[mode_slug]/kb/context7/core_concepts/_index.json`
                    *   Example: `- API Reference: .ruru/modes/[mode_slug]/kb/context7/api/_index.json`

                *Note: This summary is auto-generated based on the presence of `_index.json` files.*
                ```
        *   Use file writing tools (Prefer MCP `write_file_content`, fallback `write_to_file`) to create/overwrite `[summary_rule_path]` with the prepared content. Ensure the directory `[rules_dir]` exists (Prefer MCP `create_directory`, fallback `execute_command mkdir -p`).
        *   Log any errors encountered during scanning or writing.
        *   Report completion or failure back to the Coordinator.
    *   **3.3:** Coordinator handles delegate errors (Log, potentially **Stop**).

*   **Step 4: Update/Create KB Usage Strategy (Coordinator delegates to Mode Structure Agent)**
    *   **4.1:** Instruct Mode Structure Agent to:
        *   Define `[usage_strategy_path] = .ruru/modes/[mode_slug]/kb/00-kb-usage-strategy.md`.
        *   Check if `[usage_strategy_path]` exists (Prefer MCP `get_filesystem_info`, fallback `list_files`).
        *   If it does NOT exist: Create it using standard content (defined elsewhere or a template). (Prefer MCP `write_file_content`, fallback `write_to_file`). Handle errors (Log).
        *   If it exists: Log that it already exists.
    *   **4.2:** Handle delegate errors.

*   **Step 5: Update Mode Definition Context (Coordinator delegates to Mode Structure Agent)**
    *   **5.1:** Instruct Mode Structure Agent to:
        *   Define `[mode_file_path] = .ruru/modes/[mode_slug]/[mode_slug].mode.md`.
        *   Define `[context7_index_context_path] = kb/context7/_index.json`.
        *   Read `[mode_file_path]` (Prefer MCP `read_file_content`, fallback `read_file`). Handle errors (Log, **Stop**).
        *   Parse TOML frontmatter.
        *   Check if `[context7_index_context_path]` is already in the `related_context` array.
        *   If NOT present: Add it. Re-serialize TOML. Use `apply_diff` (or MCP `edit_file_content`) to update the TOML block in `[mode_file_path]`. Handle errors (Log, **Stop**).
        *   If present: Log that context already exists.
    *   **5.2:** Handle delegate errors.

*   **Step 6: Update KB README (Coordinator delegates to Mode Structure Agent)**
    *   **6.1:** Instruct Mode Structure Agent to update `.ruru/modes/[mode_slug]/kb/README.md`.
    *   **6.2:** Ensure README includes:
        *   Overview of the KB.
        *   List of KB subdirectories (e.g., `context7`, `local_docs`) and a brief description of their contents, linking to their respective `_index.json` files where applicable.
        *   A specific mention of the `context7` directory, linking to `context7/_index.json`, and **updating/confirming** the source URL `[context7_base_url]`. Include the `[detail_status]` (obtained/assumed) and any fetched/assumed details like token count or update date if available and relevant. # Updated README content requirement
    *   **6.3:** Use file writing/editing tools (Prefer MCP `edit_file_content` or `write_file_content`, fallback `apply_diff` or `write_to_file`). Handle errors (Log).

*   **Step 7: Quality Assurance (Coordinator applies ACQA)**
    *   **7.1:** Coordinator initiates ACQA process (`.ruru/processes/acqa-process.md`).
    *   **7.2:** Checks (potentially delegated to `QA Agent`):
        *   Presence and basic structure of files in `kb/context7/`.
        *   Validity and consistency of `kb/context7/_index.json`.
        *   Presence, validity, and correctness of the summary rule file (`.roo/rules-[mode_slug]/05-context7-summary.md`).
        *   Update status and correctness of `kb/README.md` (including the source URL and detail status). # Updated QA check
        *   Presence of `kb/00-kb-usage-strategy.md`.
        *   Correct update of `related_context` in `.mode.md`.
    *   **7.3:** Handle issues via corrections (looping back) or AFR process.

*   **Step 8: User Review (Coordinator, User)**
    *   **8.1:** Coordinator presents summary of changes (refreshed `context7` directory, generated `_index.json`, updated summary rule, updated README with detail status) to User. # Updated summary
    *   **8.2:** Ask User for feedback: "Does this Context7 KB refresh for mode `[mode_slug]` meet your expectations?"
    *   **8.3:** Handle refinements by looping back to relevant steps if necessary, followed by QA.

*   **Step 9: Finalization (Coordinator)**
    *   **9.1:** Log successful completion of Context7 refresh for `[mode_slug]` using URL `[context7_base_url]`, including generation/update of the summary rule and the detail status (`[detail_status]`). # Updated logging
    *   **9.2:** Report success to the User/initiating process.

## 7. Postconditions ‚úÖ

*   Refreshed context files exist in `.ruru/modes/[mode_slug]/kb/context7/`.
*   Valid `_index.json` exists at `.ruru/modes/[mode_slug]/kb/context7/_index.json`.
*   An updated summary rule file exists at `.roo/rules-[mode_slug]/05-context7-summary.md` (or similar prefix).
*   The mode's KB README `.ruru/modes/[mode_slug]/kb/README.md` references the `context7` directory, its `_index.json`, the confirmed source URL, and the detail status. # Updated postcondition
*   The mode's usage strategy exists at `.ruru/modes/[mode_slug]/kb/00-kb-usage-strategy.md`.
*   The mode's definition file `.ruru/modes/[mode_slug]/[mode_slug].mode.md` has `kb/context7/_index.json` in `related_context`.

## 8. Error Handling & Escalation (Overall) ‚ö†Ô∏è

*   Log errors at each step. Use AFR process for persistent issues.
*   Failure getting inputs or confirming URL/detail status (Step 1) is critical -> **Stop**. # Updated error condition
*   Failure cleaning directory (Step 1.B - permissions) or executing script (Step 2) is critical -> **Stop**.
*   Failure generating summary rule (Step 3) may require manual intervention or **Stop**.
*   Failure in README or mode definition updates (Steps 5, 6) may require manual intervention or **Stop**.
*   QA failures (Step 7) trigger correction loops or AFR.
*   User rejection (Step 8) triggers refinement loops or documented closure.

## 9. PAL Validation Record üß™

*   Date Validated: TBD
*   Method: TBD (Test Case Execution)
*   Test Case(s): Refresh existing mode 'X' using Context7 URL 'Y'. Verify KB files, `_index.json`, summary rule, README, usage strategy, and mode definition. Test both fetching details and falling back to assumptions. # Updated test case description
*   Findings/Refinements: TBD

## 10. Revision History üìú

*   v1.0 (2025-04-27): Initial version adapted from `WF-CONTEXT7-ENRICHMENT-001` (v1.2). Modified for refresh: retrieves URL from README, cleans existing directory before script execution.
*   v1.1 (2025-04-27): Modified Step 1 to retrieve `context7_base_url` from `kb/context7/source_info.json` instead of `kb/README.md`. Updated version, objective, scope, and preconditions accordingly.
*   v1.2 (2025-04-27): Added optional detail fetching (MCP/Crawl/Manual) in Step 1.8 with fallback to assumed token count (10M). Updated subsequent steps (README, QA, Logging, etc.) and descriptions to reflect detail status (obtained/assumed). Updated version, date, roles, preconditions, tools, steps, postconditions, error handling, PAL, and revision history. # Updated revision note